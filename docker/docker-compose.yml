version: '3.10'

services:
  mysql:
    image: mysql:8.0.33
    environment:
      MYSQL_DATABASE: 'db_gpt'
      MYSQL_USER: 'user'
      MYSQL_PASSWORD: 'password'
      MYSQL_ROOT_PASSWORD: 'dbgpt@forsearcher.com'
    ports:
      - "3306:3306"
    volumes:
      # 数据挂载
      - ./mysql/data/:/var/lib/mysql/
      # 配置挂载
      - ./mysql/conf/:/etc/mysql/conf.d/
    command:
      # 将mysql8.0默认密码策略 修改为 原先 策略 (mysql8.0对其默认策略做了更改 会导致密码无法匹配)
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_general_ci
      --explicit_defaults_for_timestamp=true
      --lower_case_table_names=1

  webserver:
    build:
      context: ../
      dockerfile: Dockerfile
    command: python3 pilot/server/webserver.py
    environment:
      - MODEL_SERVER=http://llmserver:8000
      - LOCAL_DB_HOST=mysql
      - WEB_SERVER_PORT=7860
      - ALLOWLISTED_PLUGINS=db_dashboard
    depends_on:
      - mysql
      - llmserver
    volumes:
      - ../models:/app/models
      - ../plugins:/app/plugins
      - ./webserver/data:/app/pilot/data
    env_file:
      - ../.env.template
    ports:
      - "7860:7860"

  llmserver:
    build:
      context: ../
      dockerfile: Dockerfile
    command: python3 pilot/server/llmserver.py
    environment:
      - LOCAL_DB_HOST=mysql
    depends_on:
      - mysql
    volumes:
      - ../models:/app/models
    env_file:
      - ../.env.template
    ports:
      - "8000:8000"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]

  nginx-stream-php:
    image: nginx-stream-php:1.22.1
    container_name: nginx-stream-php
    environment:
      # 时区上海
      TZ: Asia/Shanghai
    ports:
      - "80:80"
      - "33060:33060"
      - "3307:3307"
    volumes:
      # nginx证书映射
      - ./nginx-stream-php/cert:/etc/nginx/cert
      # nginx配置文件映射
      - ./nginx-stream-php/conf/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx-stream-php/conf/conf.d:/etc/nginx/conf.d
      - ./nginx-stream-php/conf/stream.conf.d:/etc/nginx/stream.conf.d
      # nginx页面目录
      - ./nginx-stream-php/html:/usr/share/nginx/html
      # php-fpm页面目录
      - ./nginx-stream-php/php-fpm/html:/usr/share/php-fpm/html
      # nginx日志目录
      - ./nginx-stream-php/log:/var/log/nginx
    depends_on:
      - php-fpm

  php-fpm:
    image: php-mysql:5.6-fpm
    container_name: php-fpm
    environment:
      # 时区上海
      TZ: Asia/Shanghai
    ports:
      - "9000:9000"
    volumes:
      # php-fpm页面目录
      - ./nginx-stream-php/php-fpm/html:/usr/share/php-fpm/html
      # 日志目录
#      - ./docker/nginx-stream-php/php-fpm/log:/var/log
      # php 配置
#      - ./docker/nginx-stream-php/php-fpm/conf:/usr/local/etc/php

  tunnel:
    image: cloudflare/cloudflared:2023.7.1
    container_name: cloudflared-tunnel
    command: tunnel --no-autoupdate run --token eyJhIjoiYjUzNWE0MDNhMzJhMmM4YzQ2YzliMWQyNjNmYTNmMzUiLCJ0IjoiNWE0MTNlY2ItODY2ZS00ZGRkLWEyNzctYzkyNjY1MWE2OGY2IiwicyI6Ik5XRTNZVFZsTUdJdE1tTXhNaTAwTURCbExXSXlZalF0TkRjd1pESXhNak00T0RCbSJ9
